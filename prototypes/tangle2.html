<html>
<head>
<script src='../toolkit/scripts/jquery.js'></script>
<style type="text/css">

canvas, pre {
	border-color: black;
	border-style: solid;
	border-width: 0px;
}
pre b {
    color: red;
}
#example { 
    border: 1px solid #888;
    float: left;
    padding: 1em;
    }
#code {
    float: left;
    padding-right: 1em;

}
#popup { 
    position: absolute; left: 0px; top: 100px; 
    background-color: white;
    border: 2px solid #444;
    padding: 15px;
    font-size: 15pt;
    border-radius: 9px;
}
.shadow {
    box-shadow: 0px 3px 7px #888;
}
</style>
</head>
<body>

<h1>This is a Canvas Tangle Example</h1>
<p>Drag the red numbers left and right to adjust.</p>
<div id="example">
<pre id="code">this is code</pre>
<canvas id="canvas" width="300" height="100"></canvas>
</div>

<div id="popup" class='shadow'>000</div>

<script type="text/javascript">



function Tangle() {
    this.vars = {novar:0};
    this.startX = 0;
    this.startValue = 0;
    var self = this;
    this.drawfun = null;
    this.code = null;
    this.down = false;
    this.ai = -1;
    this.clear = function(ctx) {
        ctx.fillStyle = "#f0f0f0";
        ctx.fillRect(0,0,300,100);
    }

    this.invokeFunction = function() {
        var ctx = self.canvas.getContext('2d');
        self.clear(ctx);
        var values = [ctx];
        for(var id in self.vars) {
            values.push(self.vars[id]);
        }
        self.drawfun.apply(this,values);
        //self.drawfun.apply(this,[ctx,self.vars['var1'],self.vars['var2']]);
    }
    this.setup = function() {
        self.invokeFunction();
        var src = self.drawfun.toString().split("\n");
        var val = "";
        for(var i=0; i<src.length; i++) {
            if(i==0) continue;
            if(i == src.length-1) continue;
            val += src[i];
            val += "\n";
        }
        
        for(var id in self.vars) {
            val = val.replace(new RegExp(id),"<b id='"+id+"'>"+self.vars[id]+"</b>");
        }
        self.code.innerHTML = val;
        $("#popup").hide();
        
        for(var id in self.vars) {
            var varx = document.getElementById(""+id);
            console.log("setting up: " + id + " varx = " + varx);
            varx.addEventListener('mousedown',function(e){
                var id = $(this).attr("id");
                console.log("mousedown on " + id );
                e.preventDefault();
                self.startX = e.clientX;
                self.startValue = self.vars[id];
                self.down = true;
                self.addListeners();
                self.activeID = id;
                $("#popup").show();
                $("#popup").css("top",(e.clientY-80)+"px");
                $("#popup").css("left",(e.clientX-30)+"px");
                console.log("set startx to : " + self.startX + " " + self.startValue  + " for var " + id);
            },true);
        }
    };
    
    this.doc_mouse_move = function(e){
        if(self.down) {
            e.preventDefault();
            if(e.which == 1) {
                var newvalue = (e.clientX-self.startX) + self.startValue;
                self.vars[self.activeID] = newvalue;
                //self.values[self.ai] = (e.clientX - self.startX) + self.startValue;
                var elem = document.getElementById(self.activeID);
                elem.innerHTML = newvalue;
                self.invokeFunction();
                //var ctx = self.canvas.getContext('2d');
                //self.clear(ctx);
                //self.drawfun(ctx,self.vars['var1'],self.vars['var2']);
                $("#popup").css("left",(e.clientX-30)+"px");
                $("#popup").text(""+newvalue);
            }
        }
    };
    
    this.doc_mouse_up = function(e){
        if(self.down) {
            e.preventDefault();
            self.down = false;
            self.removeListeners();
            $("#popup").hide();
        }
    };
    
    this.addListeners = function() {
        document.addEventListener('mousemove',self.doc_mouse_move);
        document.addEventListener('mouseup',self.doc_mouse_up);
    }
    
    this.removeListeners = function() {
        document.removeEventListener('mousemove',self.doc_mouse_move);
        document.removeEventListener('mouseup',self.doc_mouse_up);
    }
    
}



function drawit(ctx, var1, var2, var3, var4) {
    ctx.fillStyle = "red";
    ctx.fillRect(var1,var2,var3,var4);
}


var tangle = new Tangle();
tangle.vars = {
    var1:20,
    var2:30,
    var3:40,
    var4:50,
    };
tangle.canvas = document.getElementById("canvas");
tangle.code = document.getElementById("code");
tangle.drawfun = drawit;
tangle.setup();
</script>
</body>
</html>